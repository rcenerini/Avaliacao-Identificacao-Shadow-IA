version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITLAB_TOKEN=${GITLAB_TOKEN:-}
      - TARGET_ORGANIZATION=${TARGET_ORGANIZATION:-my_org}
      - OPA_URL_BASE=http://opa:8181/v1/data/exceptions
      - OPA_URL=http://opa:8181/v1/data/saga/governance/allow
    volumes:
      - .:/app
    command: uvicorn api.webhook_server:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      - opa

  opa:
    image: openpolicyagent/opa:latest-debug
    ports:
      - "8181:8181"
    volumes:
      - ./opa:/policy
    command: [ "run", "--server", "--addr=0.0.0.0:8181", "--log-level=debug", "/policy/policy.rego" ]

  frontend:
    build:
      context: ./dashboard-ui
      dockerfile: Dockerfile
    ports:
      - "5173:5173"
    environment:
      - VITE_API_BASE_URL=http://localhost:8000
    volumes:
      - ./dashboard-ui:/app
      - /app/node_modules
    depends_on:
      - backend
